WITH COR AS (
    SELECT 
        CR_CLS.CR_CLS_PAC_REG AS CLS_PAC,
        CR_CLS.CR_CLS_COR_COD AS CLS_COR_COD,
        CR_CLS.CR_CLS_DTHR AS CLS_DTHR,
        ROW_NUMBER() OVER (PARTITION BY CR_CLS.CR_CLS_PAC_REG ORDER BY CR_CLS.CR_CLS_DTHR DESC) AS RN
    FROM CR_CLS
    GROUP BY CR_CLS.CR_CLS_PAC_REG, CR_CLS.CR_CLS_COR_COD, CR_CLS.CR_CLS_DTHR
),
PRESC AS (
    SELECT  PSC.PSC_PAC PAC_PSC,
            PSC.PSC_TXT_RESUMIDO DIETA,
            PSC.PSC_HSP,
            ROW_NUMBER() OVER (PARTITION BY PSC.PSC_PAC ORDER BY PSC.PSC_DHINI DESC) AS RN
    FROM PSC
    WHERE PSC.PSC_TIP ='D' ),
CONTROLE AS (
    SELECT CTL.CTL_PAC AS PAC_CTL,
       CTL.CTL_HSP AS HSP_CTL,
       CTL.CTL_TAS AS PA_SIS,
       CTL.CTL_TAD AS PA_DIS,
       CTL.CTL_FC AS FREQ_CAR,
       CTL.CTL_RESP AS FREQ_RESP,
       CTL.CTL_TEMP AS TEMP,
       ROW_NUMBER() OVER (PARTITION BY CTL.CTL_PAC ORDER BY CTL.CTL_DTHR DESC) AS RN
    FROM CTL
)

SELECT STR.STR_COD AS COD_SET,
       STR.STR_NOME AS DESCRICAO, 
       LOC.LOC_COD AS LEITO,
       HSP.HSP_DTHRE AS DH_ENTRADA,
       PAC.PAC_PRONT AS COD_PTR,
       PAC.PAC_REG COD_PAC,
       PAC.PAC_NOME AS NOME_DO_PACIENTE,
       CONVERT(VARCHAR,PAC.PAC_NASC, 103) AS IDADE,
       CONCAT(
       DATEDIFF(hour, HSP.HSP_DTHRE, GETDATE()), ' hrs ', DATEPART(minute, GETDATE() - HSP.HSP_DTHRE), ' min' ) AS TEMPO_LEITO,
       DATEDIFF(HOUR,HSP.HSP_DTHRE, GETDATE()) / 24 AS DIAS_LEITO,
       DATEDIFF(hour, HSP.HSP_DTHRE, GETDATE()) AS HORA,
       CR_COR.CR_COR_NOME AS CLASSE_RISCO,
       PRESC.DIETA,
       DBO.F_RESULT_RCL(RCL.RCL_TXT, 121290, 3) AS TRANSFERENCIA,
       CONTROLE.PA_SIS AS PAS,
       CONTROLE.PA_DIS AS PAD,
       CONTROLE.FREQ_CAR AS FC,
       CONTROLE.FREQ_RESP AS FR,
       CONTROLE.TEMP AS TEMPERATURA
FROM LOC 
     INNER JOIN HSP ON (HSP.HSP_LOC = LOC.LOC_COD)  AND (HSP.HSP_STAT = 'A')
     INNER JOIN PAC ON (HSP.HSP_PAC = PAC.PAC_REG)
     INNER JOIN STR ON (LOC.LOC_STR = STR.STR_COD)
     INNER JOIN COR ON (HSP.HSP_PAC = COR.CLS_PAC) AND (COR.RN = 1)
     INNER JOIN CR_COR ON (COR.CLS_COR_COD = CR_COR.CR_COR_COD)
     LEFT JOIN PRESC ON (HSP.HSP_PAC = PRESC.PAC_PSC) AND (HSP.HSP_NUM = PRESC.PSC_HSP) AND (PRESC.RN = 1)
     LEFT JOIN CONTROLE ON (HSP.HSP_PAC = CONTROLE.PAC_CTL) AND (HSP.HSP_NUM = CONTROLE.HSP_CTL) AND (CONTROLE.RN = 1)
     LEFT JOIN RCL ON (HSP.HSP_NUM = RCL.RCL_HSP) AND (HSP.HSP_PAC = RCL.RCL_PAC) AND (RCL.RCL_COD = 'TRANSUPA') AND (RCL.RCL_TPCOD = 'S')

WHERE STR.STR_COD IN ('136', 'AH', 'AI')

SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO


CREATE FUNCTION [dbo].[F_RESULT_RCL] (@TEXTO_RCL VARCHAR (max), @DESCRITOR VARCHAR (max), @ATRIBUTO VARCHAR (max))
RETURNS VARCHAR (max)
AS
BEGIN

DECLARE @TEXTO_RCL_VARCHAR VARCHAR (max);
DECLARE @RESULTADO VARCHAR (max);

SET @TEXTO_RCL_VARCHAR = @TEXTO_RCL;

SET @RESULTADO =
CASE
WHEN CHARINDEX ('@#' + @DESCRITOR + '@' + @ATRIBUTO, @TEXTO_RCL_VARCHAR) <= 0
THEN '?'
ELSE
CASE
WHEN CHARINDEX ('@', SUBSTRING ( @TEXTO_RCL_VARCHAR, CHARINDEX ('@#' + @DESCRITOR + '@' + @ATRIBUTO, @TEXTO_RCL_VARCHAR) + LEN ( '@#' + @DESCRITOR + '@' + @ATRIBUTO) + 1 , 8000 ), LEN ( '@#' + @DESCRITOR + '@' + @ATRIBUTO) + 1) = 0
THEN SUBSTRING ( @TEXTO_RCL_VARCHAR, CHARINDEX ( '@#' + @DESCRITOR + '@' + @ATRIBUTO, @TEXTO_RCL_VARCHAR) + LEN ( '@#' + @DESCRITOR + '@' + @ATRIBUTO) + 1, 8000 )
ELSE SUBSTRING ( SUBSTRING ( @TEXTO_RCL_VARCHAR, CHARINDEX ('@#' + @DESCRITOR + '@' + @ATRIBUTO, @TEXTO_RCL_VARCHAR) + LEN ( '@#' + @DESCRITOR + '@' + @ATRIBUTO) + 1, 8000 ) , 1, CHARINDEX ('@', SUBSTRING ( @TEXTO_RCL_VARCHAR, CHARINDEX ('@#' + @DESCRITOR + '@' + @ATRIBUTO, @TEXTO_RCL_VARCHAR) + LEN ( '@#' + @DESCRITOR + '@' + @ATRIBUTO) + 1, 8000 )) - 1 )
END
END;

SET @RESULTADO =
CASE
WHEN CHARINDEX ('@', @RESULTADO) = 0
THEN @RESULTADO
ELSE SUBSTRING (@RESULTADO, 1, CHARINDEX ('@', @RESULTADO) - 1)
END;

RETURN @RESULTADO;

END

GO